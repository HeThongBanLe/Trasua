<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tải ảnh lên trang web</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px 0; padding: 5px; }
    #result { margin-top: 15px; }
  </style>
</head>
<body>
  <h2>Tải ảnh lên trang web</h2>

  <!-- Nhập token -->
  <label>Nhập mã bí mật của bạn:</label><br>
  <input type="password" id="tokenInput" placeholder="Nhập token" /><br><br>

  <!-- Chọn file ảnh -->
  <input type="file" id="fileInput" multiple /><br><br>

  <!-- Nút upload -->
  <button onclick="uploadFiles()">Upload</button>

  <div id="result"></div>

  <script>
    // Cấu hình GitHub
    const username = "TraCuaToi";
    const repo = "33TruongCongDinh";
    const branch = "main";
    const tokenPrefix = "github_pat_11BWLJQDQ0L5Lk2YOnOraf_20CLCjpNbG2l5LHLAdOmUMvhXSoQz5OYQvne7CGsj5WRYLQBLB2oG6kO"; // giữ prefix trong code

    async function uploadFiles() {
      const userToken = document.getElementById("tokenInput").value.trim();
      if (!userToken) {
        alert("Vui lòng nhập mã bí mật của bạn!");
        return;
      }
      const token = tokenPrefix + userToken;

      const files = document.getElementById("fileInput").files;
      const resultDiv = document.getElementById("result");
      if (!files.length) {
        alert("Vui lòng chọn file để upload!");
        return;
      }
      resultDiv.innerHTML = "Đang upload...<br>";

      for (let f of files) {
        try {
          // Resize ảnh
          const resizedBase64 = await resizeImage(f, 450, 370);

          const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${encodeURIComponent(f.name)}?ref=${branch}`;

          // Kiểm tra file đã tồn tại để lấy sha
          let sha;
          try {
            const checkRes = await fetch(apiUrl, {
              headers: { "Authorization": `token ${token}` }
            });
            if (checkRes.status === 200) {
              const data = await checkRes.json();
              sha = data.sha; // file đã tồn tại → dùng sha để ghi đè
            }
          } catch(err) {
            // Nếu file chưa tồn tại hoặc lỗi GET → sha = undefined
          }

          // Upload file
          const body = {
            message: `Upload ${f.name} (resized 450x370)`,
            content: resizedBase64,
            branch: branch
          };
          if (sha) body.sha = sha; // chỉ thêm sha nếu file đã tồn tại

          const res = await fetch(apiUrl, {
            method: "PUT",
            headers: {
              "Authorization": `token ${token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          const result = await res.json();
          if (res.status === 201 || res.status === 200) {
            const url = result.content.download_url;
            resultDiv.innerHTML += `✅ ${f.name} → <a href="${url}" target="_blank">${url}</a><br>`;
          } else {
            resultDiv.innerHTML += `❌ Lỗi upload ${f.name}: ${JSON.stringify(result)}<br>`;
          }
        } catch (err) {
          resultDiv.innerHTML += `⚠️ Lỗi xử lý file ${f.name}: ${err}<br>`;
        }
      }
    }

    // Resize ảnh về kích thước mong muốn
    function resizeImage(file, width, height) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            const dataUrl = canvas.toDataURL("image/jpeg");
            resolve(dataUrl.split(",")[1]); // chỉ lấy base64
          };
          img.onerror = err => reject(err);
          img.src = e.target.result;
        };
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
